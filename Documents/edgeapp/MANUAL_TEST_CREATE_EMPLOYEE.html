<!DOCTYPE html>
<html>
<head>
    <title>Manual Create Employee Test</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Manual Create Employee Test</h1>
    <p>This tests the FINAL_EDGE_ONLY_v2.0 approach directly</p>
    
    <button onclick="testCreateEmployee()">Test Create Employee</button>
    <div id="output"></div>

    <script>
        // Use correct Supabase keys
        const supabase = window.supabase.createClient(
            'https://wvggehrxhnuvlxpaghft.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind2Z2dlaHJ4aG51dmx4cGFnaGZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3ODMwMTYsImV4cCI6MjA3MDM1OTAxNn0.64TJpM2_6XZyUlOaVFrPSXqwvKn6QrTDukheC8EbVxo'
        );

        function log(message) {
            document.getElementById('output').innerHTML += '<br>' + message;
            console.log(message);
        }

        async function testCreateEmployee() {
            log('üöÄ Starting Manual Create Employee Test');
            log('=====================================');
            
            try {
                // Step 1: Check if user is logged in
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    log('‚ùå Session error: ' + sessionError.message);
                    log('Please log in first at: https://lucerne-edge-app.vercel.app');
                    return;
                }
                
                if (!session?.access_token) {
                    log('‚ùå No session found - please log in first');
                    log('Go to https://lucerne-edge-app.vercel.app and log in');
                    return;
                }

                log('‚úÖ Session found for: ' + session.user.email);
                log('‚úÖ Access token length: ' + session.access_token.length);

                // Step 2: Test Edge Function directly (v2.0 approach)
                const testEmployeeData = {
                    name: 'Manual Test User ' + Date.now(),
                    email: `manualtest${Date.now()}@lucerneintl.com`,
                    role: 'employee',
                    job_title: 'Manual Test Position',
                    department: 'IT'
                };

                log('üß™ Testing with employee data: ' + JSON.stringify(testEmployeeData));

                // Step 3: Call Edge Function with proper auth headers (FINAL v2.0)
                log('üì° Calling Edge Function admin-operations with Bearer token...');
                
                const response = await fetch('https://wvggehrxhnuvlxpaghft.supabase.co/functions/v1/admin-operations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`, // CRITICAL v2.0 fix
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'create_user',
                        data: testEmployeeData
                    })
                });

                log('üìä Response status: ' + response.status);
                
                const result = await response.json();
                log('üìä Response body: ' + JSON.stringify(result, null, 2));

                if (response.status === 200 && result.success) {
                    log('üéâ SUCCESS! Edge Function working correctly');
                    log('‚úÖ Auth user created: ' + result.user?.id);
                    log('‚úÖ Employee created: ' + result.employee?.id);
                    
                    if (result.user?.id && result.employee?.id) {
                        log('‚úÖ PERFECT: Both auth user and employee record created');
                        log('üîê Login credentials: ' + JSON.stringify({
                            email: testEmployeeData.email,
                            password: 'TempPass123!',
                            canLoginNow: true
                        }));
                    }
                } else {
                    log('‚ùå Edge Function failed');
                    log('Status: ' + response.status);
                    log('Error: ' + (result.error || 'Unknown error'));
                    if (result.debug) {
                        log('Debug: ' + JSON.stringify(result.debug));
                    }
                }

            } catch (error) {
                log('üí• Test failed with error: ' + error.message);
                if (error.message.includes('403')) {
                    log('üîç 403 error suggests auth token issues');
                }
            }

            log('=====================================');
            log('üèÅ MANUAL TEST COMPLETED');
        }
    </script>
</body>
</html>